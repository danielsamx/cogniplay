<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Sopa M√°gica</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        background: radial-gradient(
          circle at center,
          #ffffff,
          #e2d1f9,
          #d0e8ff
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        font-family: sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
      }
      .letter-cell {
        aspect-ratio: 1;
        transition: all 0.1s ease;
        touch-action: none;
        user-select: none;
      }
      .letter-cell.selecting {
        background: #9333ea !important;
        color: white;
        transform: scale(0.9);
        border-radius: 8px;
      }
      .letter-cell.found {
        background: #16a34a !important;
        color: white;
        animation: pulse 0.4s;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Estilo de Pistas en Grid */
      .clue-card {
        cursor: pointer;
        transition: all 0.2s ease;
        aspect-ratio: 1; /* Cuadradas */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        border-radius: 1rem;
        border: 2px solid white;
        background: white;
      }
      .clue-card img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Imagen ocupa todo el espacio */
      }
      .clue-card:hover {
        transform: scale(1.05);
        border-color: #9333ea;
        z-index: 10;
      }
      .clue-hidden {
        filter: grayscale(1);
        opacity: 0.2;
        pointer-events: none;
      }

      [data-tooltip] {
        position: relative;
      }
      [data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        opacity: 0;
        visibility: hidden;
        transition: 0.2s;
        z-index: 50;
      }
      [data-tooltip]:hover::after {
        opacity: 1;
        visibility: visible;
      }
    </style>
  </head>
  <body class="p-2 sm:p-4 text-slate-800">
    <nav
      class="sticky top-0 z-40 w-full py-2 mb-4 sm:mb-8 px-2"
      role="navigation"
    >
      <div class="max-w-5xl mx-auto flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 sm:gap-4">
          <div class="flex items-center gap-2 group cursor-default">
            <img
              src="../assets/logo.png"
              alt="Logo"
              class="w-6 h-6 md:w-12 md:h-12"
            />
            <span
              class="text-lg sm:text-xl font-black tracking-tight hidden xs:block"
              >Cogni<span class="text-purple-600">Play</span></span
            >
          </div>
          <div class="h-6 sm:h-8 w-[1px] bg-slate-200 mx-1"></div>
          <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
            <a
              href="explorar.html"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              data-tooltip="Ir a juegos"
              >üéÆ</a
            >
            <button
              onclick="location.reload()"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              data-tooltip="Reiniciar"
            >
              üîÑ
            </button>
          </div>
        </div>

        <div class="flex gap-1 sm:gap-2">
          <div
            class="flex bg-slate-100 p-1 rounded-xl sm:rounded-2xl shadow-inner"
          >
            <div
              class="px-2 sm:px-4 py-1 rounded-lg sm:rounded-xl bg-white shadow-sm flex flex-col items-center min-w-[50px]"
            >
              <span
                class="text-[7px] sm:text-[9px] uppercase font-black text-purple-500"
                >Nivel</span
              >
              <span
                id="level-display"
                class="text-sm sm:text-lg font-black leading-none"
                >1</span
              >
            </div>
            <div
              class="px-2 sm:px-4 py-1 rounded-lg sm:rounded-xl flex flex-col items-center min-w-[50px]"
            >
              <span
                class="text-[7px] sm:text-[9px] uppercase font-black text-yellow-500"
                >Puntos</span
              >
              <span
                id="score-display"
                class="text-sm sm:text-lg font-black leading-none text-slate-700"
                >0</span
              >
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main
      class="max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 px-2"
    >
      <aside class="lg:col-span-3 order-2 lg:order-1">
        <div
          class="bg-purple-600 text-white py-2 rounded-t-xl text-center font-black text-[10px] uppercase tracking-widest"
        >
          Pistas
        </div>
        <div
          id="clues-container"
          class="glass p-3 rounded-b-xl grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-2 gap-2 max-h-[400px] lg:max-h-none overflow-y-auto"
        ></div>
      </aside>

      <section
        class="lg:col-span-9 order-1 lg:order-2 flex flex-col items-center"
      >
        <div class="w-full max-w-md flex flex-col items-center mb-6">
          <div
            class="flex items-center gap-2 px-4 py-1 bg-white rounded-t-xl border border-b-0 border-slate-100 shadow-sm"
          >
            <span class="animate-pulse text-sm">‚è±Ô∏è</span>
            <span
              id="timer-text"
              class="font-mono font-bold text-lg text-slate-700"
              >100%</span
            >
          </div>
          <div
            class="w-full bg-slate-200 h-3 rounded-full overflow-hidden shadow-inner border border-white"
          >
            <div
              id="timer-progress"
              class="h-full bg-gradient-to-r from-blue-400 to-purple-500 w-full transition-all duration-300"
            ></div>
          </div>
        </div>

        <div
          id="game-grid"
          class="glass p-2 sm:p-4 rounded-[1.5rem] shadow-2xl grid gap-1 sm:gap-2 w-full max-w-[500px] aspect-square"
        ></div>
      </section>
    </main>

    <div
      id="modal-overlay"
      class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4"
    >
      <div
        class="glass p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center border-4 border-white"
      >
        <h2
          id="modal-title"
          class="text-2xl sm:text-3xl font-black mb-2 text-slate-800 uppercase"
        ></h2>
        <div id="modal-body" class="text-slate-600 font-medium mb-6"></div>
        <button
          id="modal-btn"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-3 rounded-2xl shadow-lg transition-transform active:scale-95 text-lg"
        ></button>
      </div>
    </div>

    <audio id="snd-match" src="../music/match.mp3"></audio>
    <audio id="snd-wrong" src="../music/wrong.mp3"></audio>
    <audio id="snd-win" src="../music/game-win.mp3"></audio>
    <audio id="snd-gameover" src="../music/game-over.mp3"></audio>

    <script>
      const transportes = [
        "avion",
        "barco",
        "bicicleta",
        "bus",
        "carro",
        "cohete",
        "dron",
        "ferry",
        "globo",
        "helicoptero",
        "motocicleta",
        "patineta",
        "submarino",
        "taxi",
        "tractor",
        "tranvia",
        "tren",
        "velero",
      ];
      const animales = [
        "ballena",
        "burro",
        "caballo",
        "cebra",
        "cerdo",
        "conejo",
        "delfin",
        "elefante",
        "flamenco",
        "gallina",
        "gato",
        "hipopotamo",
        "jirafa",
        "leon",
        "loro",
        "mono",
        "oso",
        "oveja",
        "panda",
        "pato",
        "perro",
        "pez",
        "pinguino",
        "pulpo",
        "rinoceronte",
        "tiburon",
        "tigre",
        "tortuga",
        "vaca",
      ];

      let level = 1,
        score = 0,
        timeLeft = 100,
        timerInterval;
      let wordsInLevel = [],
        isSelecting = false,
        startCell = null,
        selectedCells = [];

      function initGame() {
        clearInterval(timerInterval);
        timeLeft = 100;
        updateUI();

        const category = level % 2 === 0 ? "transportes" : "animales";
        const pool = category === "transportes" ? transportes : animales;
        const numWords = Math.min(4 + Math.floor(level / 2), 8); // M√°s palabras en niveles altos

        wordsInLevel = [...pool]
          .sort(() => 0.5 - Math.random())
          .slice(0, numWords)
          .map((w) => ({
            word: w.toUpperCase(),
            category: category,
            found: false,
            mode: Math.floor(Math.random() * 3),
          }));

        generateBoard();
        renderClues();
        startTimer();
      }

      function generateBoard() {
        const size = window.innerWidth < 640 ? 8 : 10;
        const grid = document.getElementById("game-grid");
        grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        grid.innerHTML = "";

        let board = Array(size)
          .fill()
          .map(() => Array(size).fill(""));

        wordsInLevel.forEach((obj) => {
          let placed = false;
          let attempts = 0;
          while (!placed && attempts < 100) {
            const isH = Math.random() > 0.5;
            const r = Math.floor(
              Math.random() * (isH ? size : size - obj.word.length),
            );
            const c = Math.floor(
              Math.random() * (isH ? size - obj.word.length : size),
            );
            let canPlace = true;
            for (let i = 0; i < obj.word.length; i++) {
              if (board[r + (isH ? 0 : i)][c + (isH ? i : 0)] !== "") {
                canPlace = false;
                break;
              }
            }
            if (canPlace) {
              for (let i = 0; i < obj.word.length; i++)
                board[r + (isH ? 0 : i)][c + (isH ? i : 0)] = obj.word[i];
              placed = true;
            }
            attempts++;
          }
        });

        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            const cell = document.createElement("div");
            cell.className =
              "letter-cell glass flex items-center justify-center font-black text-slate-700 text-sm sm:text-xl rounded-lg cursor-pointer shadow-sm";
            cell.dataset.r = r;
            cell.dataset.c = c;
            cell.innerText =
              board[r][c] ||
              "ABCDEGHJKLMNOPRSTUV"[Math.floor(Math.random() * 19)];

            cell.onmousedown = (e) => handleStart(cell);
            cell.onmouseenter = () => handleMove(cell);
            cell.ontouchstart = (e) => {
              e.preventDefault();
              handleStart(cell);
            };
            grid.appendChild(cell);
          }
        }
      }

      function renderClues() {
        const container = document.getElementById("clues-container");
        container.innerHTML = "";
        wordsInLevel.forEach((w) => {
          const card = document.createElement("div");
          card.id = `clue-${w.word}`;
          card.className = "clue-card shadow-sm";

          if (w.mode === 0) {
            // IMAGEN COMPLETA
            card.innerHTML = `<img src="../images/${w.category}/${w.word.toLowerCase()}.webp">`;
            card.setAttribute("data-tooltip", "Busca la imagen");
          } else if (w.mode === 1) {
            // TEXTO
            card.innerHTML = `<span class="text-[10px] sm:text-xs font-black text-purple-600 px-1 text-center">${w.word}</span>`;
            card.setAttribute("data-tooltip", "Busca la palabra");
          } else {
            // AUDIO
            card.innerHTML = `<div class="flex flex-col items-center"><span class="text-2xl sm:text-3xl">üîä</span><span class="text-[7px] font-bold text-slate-400 uppercase">O√≠r</span></div>`;
            card.onclick = (e) => {
              e.stopPropagation();
              speak(w.word);
            };
            card.setAttribute("data-tooltip", "Haz clic para escuchar");
          }
          container.appendChild(card);
        });
      }

      function speak(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text.toLowerCase());
        utterance.lang = "es-ES";
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
      }

      function handleStart(cell) {
        if (cell.classList.contains("found")) return;
        isSelecting = true;
        startCell = {
          r: parseInt(cell.dataset.r),
          c: parseInt(cell.dataset.c),
        };
        selectedCells = [cell];
        cell.classList.add("selecting");
        window.onmouseup = handleEnd;
        window.ontouchend = handleEnd;
      }

      function handleMove(cell) {
        if (!isSelecting || cell.classList.contains("found")) return;
        document
          .querySelectorAll(".letter-cell.selecting")
          .forEach((c) => c.classList.remove("selecting"));
        selectedCells = [];
        const r2 = parseInt(cell.dataset.r),
          c2 = parseInt(cell.dataset.c);
        const dr = r2 - startCell.r,
          dc = c2 - startCell.c;
        if (dr !== 0 && dc !== 0 && Math.abs(dr) !== Math.abs(dc)) return;

        const steps = Math.max(Math.abs(dr), Math.abs(dc));
        const stepR = dr === 0 ? 0 : dr / Math.abs(dr);
        const stepC = dc === 0 ? 0 : dc / Math.abs(dc);

        for (let i = 0; i <= steps; i++) {
          const el = document.querySelector(
            `.letter-cell[data-r="${startCell.r + i * stepR}"][data-c="${startCell.c + i * stepC}"]`,
          );
          if (el) {
            el.classList.add("selecting");
            selectedCells.push(el);
          }
        }
      }

      function handleEnd() {
        if (!isSelecting) return;
        isSelecting = false;
        const word = selectedCells.map((c) => c.innerText).join("");
        const rev = word.split("").reverse().join("");
        const match = wordsInLevel.find(
          (w) => !w.found && (word === w.word || rev === w.word),
        );

        if (match) {
          match.found = true;
          selectedCells.forEach((c) => {
            c.classList.remove("selecting");
            c.classList.add("found");
          });
          const clue = document.getElementById(`clue-${match.word}`);
          clue.classList.add("clue-hidden");
          clue.innerHTML = "‚úÖ";
          score += 200;
          playSnd("snd-match");
          updateUI();
          if (wordsInLevel.every((w) => w.found)) handleWin();
        } else {
          selectedCells.forEach((c) => c.classList.remove("selecting"));
          if (selectedCells.length > 1) playSnd("snd-wrong");
        }
        window.onmouseup = window.ontouchend = null;
      }

      function startTimer() {
        const speed = 0.12 + level * 0.04;
        timerInterval = setInterval(() => {
          timeLeft -= speed;
          document.getElementById("timer-progress").style.width =
            timeLeft + "%";
          document.getElementById("timer-text").innerText =
            Math.ceil(timeLeft) + "%";
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            playSnd("snd-gameover");
            showModal(
              "¬°TIEMPO FUERA!",
              `Lograste ${score} puntos`,
              "REINTENTAR",
              () => location.reload(),
            );
          }
        }, 100);
      }

      function handleWin() {
        clearInterval(timerInterval);
        playSnd("snd-win");
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        showModal("¬°NIVEL COMPLETADO!", `¬°Sigue as√≠!`, "SIGUIENTE", () => {
          level++;
          initGame();
        });
      }

      function showModal(title, body, btnTxt, action) {
        const modal = document.getElementById("modal-overlay");
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-body").innerText = body;
        const btn = document.getElementById("modal-btn");
        btn.innerText = btnTxt;
        btn.onclick = () => {
          modal.classList.add("hidden");
          action();
        };
        modal.classList.remove("hidden");
      }

      function playSnd(id) {
        const s = document.getElementById(id);
        if (s) {
          s.currentTime = 0;
          s.play().catch(() => {});
        }
      }

      function updateUI() {
        document.getElementById("level-display").innerText = level;
        document.getElementById("score-display").innerText = score;
      }

      window.onload = initGame;
    </script>
  </body>
</html>
