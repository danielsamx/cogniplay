<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Sopa M√°gica - CogniPlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@400;900&display=swap");

      body {
        background: radial-gradient(
          circle at center,
          #ffffff,
          #e2d1f9,
          #d0e8ff
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: "Outfit", sans-serif;
        overflow-x: hidden;
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.2s ease;
      }

      .letter-cell {
        aspect-ratio: 1;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        touch-action: none;
        user-select: none;
        outline: none;
      }

      .letter-cell:focus-visible {
        background: white;
        box-shadow: 0 0 0 4px #9333ea;
        z-index: 20;
        border-radius: 12px;
      }

      .letter-cell.selecting {
        background: #9333ea !important;
        color: white !important;
        border-radius: 8px;
        transform: scale(0.9);
      }

      .letter-cell.found {
        background: #16a34a !important;
        color: white !important;
        animation: pulse 0.4s ease-in-out;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
        100% {
          transform: scale(1);
        }
      }

      /* TOOLTIPS PERSONALIZADOS */
      [data-tooltip] {
        position: relative;
      }
      [data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 9999;
        pointer-events: none;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      }

      [data-tooltip]::before {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(15, 23, 42, 0.9) transparent transparent transparent;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 9999;
        pointer-events: none;
      }

      [data-tooltip]:hover::after,
      [data-tooltip]:focus-visible::after,
      [data-tooltip].show-tooltip::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      [data-tooltip]:hover::before,
      [data-tooltip]:focus-visible::before,
      [data-tooltip].show-tooltip::before {
        opacity: 1;
        visibility: visible;
      }

      /* Asegurar que el elemento con tooltip tenga z-index mayor al hacer hover */
      [data-tooltip]:hover,
      [data-tooltip]:focus-visible,
      [data-tooltip].show-tooltip {
        z-index: 9998;
        position: relative;
      }

      /* CONTENEDOR DE PISTAS ADAPTATIVO */
      #clues-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        width: 100%;
      }

      @media (max-width: 1023px) {
        #clues-container {
          flex-wrap: nowrap;
          justify-content: flex-start;
          overflow-x: auto;
          scroll-snap-type: x mandatory;
          -webkit-overflow-scrolling: touch;
          padding-bottom: 1.5rem;
        }
        .clue-wrapper {
          scroll-snap-align: center;
          flex: 0 0 auto;
        }
      }

      .clue-card {
        width: 70px;
        height: 70px;
        border-radius: 1.2rem;
        border: 3px solid white;
        background: white;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        overflow: visible;
        position: relative;
      }

      .clue-card img {
        overflow: hidden;
        border-radius: 1.2rem;
      }

      .clue-card:focus-visible {
        border-color: #9333ea;
        transform: scale(1.05);
        outline: none;
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.3);
        z-index: 9998;
      }

      .clue-card:hover {
        z-index: 9998;
      }

      .clue-hidden {
        filter: grayscale(1);
        opacity: 0.3;
        pointer-events: none;
        border-color: #16a34a;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .modal-animate {
        animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .paused-grid .letter-cell {
        filter: blur(10px) grayscale(1);
        pointer-events: none;
      }

      /* Accesibilidad: Foco visible */
      :focus-visible {
        outline: 3px solid #9333ea;
        outline-offset: 4px;
      }
    </style>
  </head>
  <body class="p-2 sm:p-4">
    <nav
      class="sticky top-0 z-40 w-full py-2 mb-4 px-2"
      role="navigation"
      aria-label="Navegaci√≥n principal"
    >
      <div class="max-w-5xl mx-auto flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 sm:gap-4">
          <div class="flex items-center gap-2 group cursor-default">
            <img
              src="../assets/logo.png"
              alt="Logo CogniPlay"
              class="w-6 h-6 md:w-12 md:h-12"
            />
            <span
              class="text-lg sm:text-xl font-black tracking-tight hidden xs:block"
              >Cogni<span class="text-purple-600">Play</span></span
            >
          </div>
          <div class="h-6 sm:h-8 w-[1px] bg-slate-200 mx-1"></div>
          <div
            id="top-controls"
            class="flex gap-1 bg-slate-100 p-1 rounded-xl"
            data-arrow-group
          >
            <a
              href="explorar.html"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              aria-label="Ir al men√∫ de juegos"
              data-tooltip="Ir a juegos"
              >üéÆ</a
            >
            <button
              id="nav-pause"
              onclick="togglePause()"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              aria-label="Pausar juego"
              aria-pressed="false"
              data-tooltip="Pausar juego"
              type="button"
            >
              ‚è∏Ô∏è
            </button>
            <button
              id="music-toggle"
              onclick="toggleMusic()"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              aria-label="Activar m√∫sica de fondo"
              aria-pressed="false"
              data-tooltip="Sonido ON/OFF"
              type="button"
            >
              üîá
            </button>
          </div>
        </div>

        <div class="flex bg-slate-100 p-1 rounded-xl shadow-inner">
          <div
            class="px-2 sm:px-4 py-1 rounded-lg bg-white shadow-sm flex flex-col items-center min-w-[50px]"
          >
            <span
              class="text-[7px] sm:text-[9px] uppercase font-black text-purple-500"
              >Nivel</span
            >
            <span
              id="level-display"
              class="text-sm sm:text-lg font-black leading-none"
              aria-live="polite"
              aria-atomic="true"
              >1</span
            >
          </div>
          <div
            class="px-2 sm:px-4 py-1 rounded-lg flex flex-col items-center min-w-[50px]"
          >
            <span
              class="text-[7px] sm:text-[9px] uppercase font-black text-yellow-500"
              >Puntos</span
            >
            <span
              id="score-display"
              class="text-sm sm:text-lg font-black leading-none text-slate-700"
              aria-live="polite"
              aria-atomic="true"
              >0</span
            >
          </div>
        </div>
      </div>
    </nav>

    <main
      class="max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8 items-center"
    >
      <aside
        class="lg:col-span-4 order-1 flex flex-col items-center gap-4 w-full"
      >
        <h2
          class="font-black text-[10px] uppercase text-slate-500 tracking-widest text-center"
        >
          Encuentra estas palabras:
        </h2>
        <div
          id="clues-container"
          class="no-scrollbar"
          role="list"
          aria-label="Palabras a encontrar"
        ></div>
      </aside>

      <section
        class="lg:col-span-8 order-2 flex flex-col items-center gap-6 w-full"
      >
        <div class="w-full max-w-md flex flex-col items-center">
          <div
            class="flex items-center gap-2 px-6 py-2 bg-white rounded-t-2xl shadow-sm border border-b-0 border-slate-50"
            role="timer"
          >
            <span class="animate-pulse text-xl" aria-hidden="true">‚è±Ô∏è</span>
            <span
              id="timer-text"
              class="font-mono font-bold text-2xl text-slate-700"
              >01:40</span
            >
          </div>
          <div
            class="w-full bg-slate-200 h-3 rounded-full overflow-hidden border-4 border-white shadow-inner"
          >
            <div
              id="timer-progress"
              class="h-full bg-gradient-to-r from-purple-500 to-blue-400 w-full transition-all duration-300"
            ></div>
          </div>
        </div>
        <div
          id="game-grid"
          class="glass p-3 sm:p-6 rounded-[2.5rem] shadow-2xl grid gap-1.5 w-full max-w-[500px] aspect-square"
          role="grid"
          aria-label="Tablero de sopa de letras"
        ></div>
      </section>
    </main>

    <div
      id="modal-overlay"
      class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-50 flex items-center justify-center hidden p-6"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
      aria-describedby="modal-body"
    >
      <div
        id="modal-content"
        class="glass p-6 sm:p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center modal-animate border-4 border-white"
      >
        <h2
          id="modal-title"
          class="text-2xl sm:text-3xl font-black mb-2 text-slate-800"
        ></h2>
        <div
          id="modal-body"
          class="text-slate-600 font-medium mb-6 text-sm sm:text-base"
        ></div>
        <div class="flex flex-col gap-3">
          <button
            id="modal-btn-primary"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-3 sm:py-4 rounded-2xl shadow-lg transition-transform active:scale-95 text-lg"
            data-tooltip="Haz clic para continuar"
          ></button>
          <a
            href="explorar.html"
            id="modal-btn-secondary"
            class="w-full bg-white/50 hover:bg-white text-slate-600 font-bold py-2 rounded-2xl transition-colors hidden text-base text-center"
            data-tooltip="Volver al men√∫"
            >Salir</a
          >
        </div>
      </div>
    </div>

    <audio id="bg-music" loop src="../music/memory-bg.mp3"></audio>
    <audio id="snd-match" src="../music/match.mp3" preload="auto"></audio>
    <audio id="snd-wrong" src="../music/wrong.mp3" preload="auto"></audio>
    <audio id="snd-win" src="../music/game-win.mp3" preload="auto"></audio>
    <audio
      id="snd-gameover"
      src="../music/game-over.mp3"
      preload="auto"
    ></audio>
    <audio id="snd-alert" loop src="../music/fast-ticking.mp3"></audio>

    <script>
      const transportes = [
        "avion",
        "barco",
        "bicicleta",
        "bus",
        "carro",
        "cohete",
        "dron",
        "ferry",
        "globo",
        "helicoptero",
        "motocicleta",
        "patineta",
        "submarino",
        "taxi",
        "tractor",
        "tranvia",
        "tren",
        "velero",
      ];
      const animales = [
        "ballena",
        "burro",
        "caballo",
        "cebra",
        "cerdo",
        "conejo",
        "delfin",
        "elefante",
        "flamenco",
        "gallina",
        "gato",
        "hipopotamo",
        "jirafa",
        "leon",
        "loro",
        "mono",
        "oso",
        "oveja",
        "panda",
        "pato",
        "perro",
        "pez",
        "pinguino",
        "pulpo",
        "rinoceronte",
        "tiburon",
        "tigre",
        "tortuga",
        "vaca",
      ];

      let level = 1,
        score = 0,
        timeLeft = 100,
        timerInterval;
      let wordsInLevel = [],
        isSelecting = false,
        startCell = null,
        selectedCells = [];
      let isPaused = false,
        isMusicPlaying = false,
        isAlertActive = false;
      let gameStarted = false;

      const grid = document.getElementById("game-grid");
      const musicBtn = document.getElementById("music-toggle");
      const bgMusic = document.getElementById("bg-music");
      const sndAlert = document.getElementById("snd-alert");
      const modal = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const btnPrimary = document.getElementById("modal-btn-primary");
      const btnSecondary = document.getElementById("modal-btn-secondary");

      function initGame() {
        clearInterval(timerInterval);
        stopAlertSfx();
        timeLeft = 100;
        updateUI();
        const category = level % 2 === 0 ? "transportes" : "animales";
        const pool = category === "transportes" ? transportes : animales;

        // Configuraci√≥n de palabras con MODALIDAD (Imagen, Texto, Voz)
        wordsInLevel = [...pool]
          .sort(() => 0.5 - Math.random())
          .slice(0, 6)
          .map((w) => ({
            word: w.toUpperCase(),
            category,
            found: false,
            mode: Math.floor(Math.random() * 3), // 0: Imagen, 1: Texto, 2: Voz
          }));

        generateBoard();
        renderClues();
        startTimer();

        setTimeout(() => {
          const firstCell = document.querySelector(".letter-cell");
          if (firstCell) firstCell.focus();
        }, 600);
      }

      function generateBoard() {
        const size = window.innerWidth < 640 ? 8 : 10;
        grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        grid.innerHTML = "";
        grid.classList.remove("paused-grid");
        let board = Array(size)
          .fill()
          .map(() => Array(size).fill(""));

        wordsInLevel.forEach((obj) => {
          let placed = false,
            attempts = 0;
          while (!placed && attempts < 100) {
            const isH = Math.random() > 0.5;
            const r = Math.floor(
              Math.random() * (isH ? size : size - obj.word.length),
            );
            const c = Math.floor(
              Math.random() * (isH ? size - obj.word.length : size),
            );
            let canPlace = true;
            for (let i = 0; i < obj.word.length; i++) {
              if (board[r + (isH ? 0 : i)][c + (isH ? i : 0)] !== "") {
                canPlace = false;
                break;
              }
            }
            if (canPlace) {
              for (let i = 0; i < obj.word.length; i++)
                board[r + (isH ? 0 : i)][c + (isH ? i : 0)] = obj.word[i];
              placed = true;
            }
            attempts++;
          }
        });

        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            const cell = document.createElement("div");
            cell.className =
              "letter-cell glass flex items-center justify-center font-black text-slate-700 text-xs sm:text-xl cursor-pointer shadow-sm";
            cell.tabIndex = 0;
            cell.dataset.r = r;
            cell.dataset.c = c;
            cell.setAttribute("role", "gridcell");
            cell.setAttribute("data-tooltip", "Seleccionar");
            cell.innerText =
              board[r][c] ||
              "ABCDEGHJKLMNOPRSTUV"[Math.floor(Math.random() * 19)];

            cell.onmousedown = () => handleStart(cell);
            cell.onmouseenter = () => handleMove(cell);
            cell.ontouchstart = (e) => {
              e.preventDefault();
              handleStart(cell);
            };
            cell.ontouchmove = (e) => {
              const touch = e.touches[0];
              const target = document.elementFromPoint(
                touch.clientX,
                touch.clientY,
              );
              if (target?.classList.contains("letter-cell")) handleMove(target);
            };
            cell.ontouchend = handleEnd;
            cell.onkeydown = (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                !isSelecting ? handleStart(cell) : handleEnd();
              }
              handleArrowNav(e, r, c, size);
            };
            grid.appendChild(cell);
          }
        }
        window.onmouseup = handleEnd;
      }

      function handleArrowNav(e, r, c, size) {
        let nr = r,
          nc = c;
        if (e.key === "ArrowUp") nr--;
        else if (e.key === "ArrowDown") nr++;
        else if (e.key === "ArrowLeft") nc--;
        else if (e.key === "ArrowRight") nc++;
        else return;
        e.preventDefault();
        const next = document.querySelector(
          `.letter-cell[data-r="${nr}"][data-c="${nc}"]`,
        );
        if (next) {
          next.focus();
          if (isSelecting) handleMove(next);
        }
      }

      function renderClues() {
        const container = document.getElementById("clues-container");
        container.innerHTML = "";
        wordsInLevel.forEach((w, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = "clue-wrapper";

          const card = document.createElement("div");
          card.id = `clue-${w.word}`;
          card.className = "clue-card";
          card.tabIndex = 0;
          card.setAttribute("role", "listitem");
          card.setAttribute("data-tooltip", w.word); // Tooltip siempre presente
          card.dataset.clueIndex = index;

          // L√≥gica Multimodal: Imagen, Texto o Voz
          if (w.mode === 0) {
            // Imagen
            card.innerHTML = `<img src="../images/${w.category}/${w.word.toLowerCase()}.webp" alt="${w.word}" class="w-full h-full object-cover rounded-xl">`;
          } else if (w.mode === 1) {
            // Texto
            card.innerHTML = `<span class="text-[10px] font-black text-purple-600 uppercase text-center px-1">${w.word}</span>`;
          } else {
            // Voz
            card.innerHTML = `<span class="text-2xl" aria-label="Reproducir palabra">üîä</span>`;
          }

          // Tap/Touch para mostrar tooltip en m√≥vil
          let tapTimeout;
          card.addEventListener("touchstart", (e) => {
            // Solo mostrar tooltip si no es una tarjeta de voz
            if (w.mode !== 2) {
              e.preventDefault();
              card.classList.add("show-tooltip");
              clearTimeout(tapTimeout);
              tapTimeout = setTimeout(() => {
                card.classList.remove("show-tooltip");
              }, 2000); // Tooltip visible por 2 segundos
            }
          });

          // Click para reproducir voz
          if (w.mode === 2) {
            card.onclick = () => speak(w.word);
          }

          // Agregar navegaci√≥n con flechas a todas las tarjetas
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              if (w.mode === 2) {
                e.preventDefault();
                speak(w.word);
              }
            }
            handleClueArrowNav(e, card);
          });

          wrapper.appendChild(card);
          container.appendChild(wrapper);
        });
      }

      function handleClueArrowNav(e, currentCard) {
        const cards = Array.from(document.querySelectorAll(".clue-card"));
        const currentIndex = parseInt(currentCard.dataset.clueIndex);
        let nextIndex = currentIndex;

        // Determinar si estamos en mobile (lista horizontal) o desktop (grid)
        const isMobile = window.innerWidth < 1024;

        if (isMobile) {
          // En mobile: navegaci√≥n horizontal
          if (e.key === "ArrowRight") nextIndex = currentIndex + 1;
          if (e.key === "ArrowLeft") nextIndex = currentIndex - 1;
        } else {
          // En desktop: navegaci√≥n en grid (3 columnas aproximadamente)
          const cols = 3;
          if (e.key === "ArrowRight") nextIndex = currentIndex + 1;
          if (e.key === "ArrowLeft") nextIndex = currentIndex - 1;
          if (e.key === "ArrowDown") nextIndex = currentIndex + cols;
          if (e.key === "ArrowUp") nextIndex = currentIndex - cols;
        }

        if (nextIndex !== currentIndex && cards[nextIndex]) {
          e.preventDefault();
          cards[nextIndex].focus();
        }
      }

      function handleStart(cell) {
        if (cell.classList.contains("found") || isPaused) return;
        isSelecting = true;
        startCell = {
          r: parseInt(cell.dataset.r),
          c: parseInt(cell.dataset.c),
        };
        selectedCells = [cell];
        cell.classList.add("selecting");
      }

      function handleMove(cell) {
        if (!isSelecting || !cell || cell.classList.contains("found")) return;
        document
          .querySelectorAll(".letter-cell.selecting")
          .forEach((c) => c.classList.remove("selecting"));
        selectedCells = [];
        const r2 = parseInt(cell.dataset.r),
          c2 = parseInt(cell.dataset.c);
        const dr = r2 - startCell.r,
          dc = c2 - startCell.c;
        if (dr !== 0 && dc !== 0 && Math.abs(dr) !== Math.abs(dc)) return;
        const steps = Math.max(Math.abs(dr), Math.abs(dc));
        const sR = dr === 0 ? 0 : dr / Math.abs(dr);
        const sC = dc === 0 ? 0 : dc / Math.abs(dc);
        for (let i = 0; i <= steps; i++) {
          const el = document.querySelector(
            `.letter-cell[data-r="${startCell.r + i * sR}"][data-c="${startCell.c + i * sC}"]`,
          );
          if (el) {
            el.classList.add("selecting");
            selectedCells.push(el);
          }
        }
      }

      function handleEnd() {
        if (!isSelecting) return;
        isSelecting = false;
        const word = selectedCells.map((c) => c.innerText).join("");
        const rev = word.split("").reverse().join("");
        const match = wordsInLevel.find(
          (w) => !w.found && (word === w.word || rev === w.word),
        );

        if (match) {
          match.found = true;
          selectedCells.forEach((c) => {
            c.classList.remove("selecting");
            c.classList.add("found");
          });
          document
            .getElementById(`clue-${match.word}`)
            .classList.add("clue-hidden");
          score += 200;
          updateUI();
          playSfx("snd-match");
          if (wordsInLevel.every((w) => w.found)) handleWin();
        } else {
          if (selectedCells.length > 1) playSfx("snd-wrong");
          selectedCells.forEach((c) => c.classList.remove("selecting"));
        }
      }

      function speak(t) {
        if (!isMusicPlaying) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t.toLowerCase());
        u.lang = "es-ES";
        window.speechSynthesis.speak(u);
      }

      function togglePause() {
        if (!gameStarted) return;
        isPaused = !isPaused;
        const pauseBtn = document.getElementById("nav-pause");
        pauseBtn.innerText = isPaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
        pauseBtn.setAttribute("aria-pressed", isPaused ? "true" : "false");
        pauseBtn.setAttribute(
          "aria-label",
          isPaused ? "Reanudar juego" : "Pausar juego",
        );

        if (isPaused) {
          clearInterval(timerInterval);
          stopAlertSfx();
          grid.classList.add("paused-grid");
          if (isMusicPlaying) bgMusic.pause();
          showModal(
            "PAUSA",
            "¬øQuieres continuar?",
            "REANUDAR",
            togglePause,
            true,
          );
        } else {
          grid.classList.remove("paused-grid");
          if (isMusicPlaying) bgMusic.play();
          if (isAlertActive) sndAlert.play();
          startTimer();
        }
      }

      function toggleMusic() {
        isMusicPlaying = !isMusicPlaying;
        musicBtn.innerText = isMusicPlaying ? "üéµ" : "üîá";
        musicBtn.setAttribute(
          "aria-pressed",
          isMusicPlaying ? "true" : "false",
        );
        musicBtn.setAttribute(
          "aria-label",
          isMusicPlaying
            ? "Desactivar m√∫sica de fondo"
            : "Activar m√∫sica de fondo",
        );

        if (isMusicPlaying && gameStarted && !isPaused) {
          bgMusic.play().catch(() => {});
        } else {
          bgMusic.pause();
        }
      }

      function playSfx(id) {
        if (!isMusicPlaying) return;
        const sound = document.getElementById(id);
        if (sound) {
          sound.currentTime = 0;
          sound.play().catch(() => {});
        }
      }

      function stopAlertSfx() {
        sndAlert.pause();
        sndAlert.currentTime = 0;
        bgMusic.volume = 1.0;
        isAlertActive = false;
        document
          .getElementById("timer-text")
          .classList.remove("text-red-500", "animate-bounce");
        document
          .getElementById("timer-progress")
          .classList.remove("bg-red-500");
      }

      function startTimer() {
        clearInterval(timerInterval);
        const speed = 0.1 + level * 0.02;
        timerInterval = setInterval(() => {
          if (isPaused) return;
          timeLeft -= speed;
          const totalSeconds = Math.max(0, Math.floor(timeLeft));
          const mins = Math.floor(totalSeconds / 60),
            secs = totalSeconds % 60;
          document.getElementById("timer-text").innerText =
            `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          document.getElementById("timer-progress").style.width =
            timeLeft + "%";

          if (timeLeft <= 10 && !isAlertActive) {
            isAlertActive = true;
            document
              .getElementById("timer-progress")
              .classList.add("bg-red-500");
            document
              .getElementById("timer-text")
              .classList.add("text-red-500", "animate-bounce");
            if (isMusicPlaying) {
              playSfx("snd-alert");
              bgMusic.volume = 0.4;
            }
          }

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            stopAlertSfx();
            bgMusic.pause(); // Pausar m√∫sica de fondo
            playSfx("snd-gameover");
            showModal(
              "TIEMPO FUERA",
              `Nivel alcanzado: ${level}`,
              "REINTENTAR",
              () => location.reload(),
              true,
            );
          }
        }, 100);
      }

      function handleWin() {
        clearInterval(timerInterval);
        stopAlertSfx();
        bgMusic.pause(); // Pausar m√∫sica de fondo al ganar
        playSfx("snd-win");
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        showModal(
          level === 10 ? "üèÜ ¬°VICTORIA!" : `¬°NIVEL ${level} LISTO!`,
          level === 10 ? `Puntos totales: ${score}` : "¬°Sigue as√≠!",
          level === 10 ? "REINICIAR" : "CONTINUAR",
          () => {
            if (level < 10) {
              level++;
              if (isMusicPlaying) bgMusic.play(); // Reanudar m√∫sica al continuar
              initGame();
            } else {
              level = 1;
              score = 0;
              if (isMusicPlaying) bgMusic.play(); // Reanudar m√∫sica al reiniciar
              initGame();
            }
          },
          true,
        );
      }

      function showModal(
        title,
        bodyHTML,
        primaryText,
        primaryAction,
        showExit = false,
      ) {
        modalTitle.innerText = title;
        modalBody.innerHTML = bodyHTML;
        btnPrimary.innerText = primaryText;
        btnPrimary.onclick = () => {
          modal.classList.add("hidden");
          primaryAction();
        };
        btnSecondary.classList.toggle("hidden", !showExit);
        modal.classList.remove("hidden");
        setTimeout(() => btnPrimary.focus(), 100);
      }

      function updateUI() {
        document.getElementById("level-display").innerText = level;
        document.getElementById("score-display").innerText = score;
      }

      // Navegaci√≥n con flechas
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && gameStarted) {
          event.preventDefault();
          togglePause();
        }
      });

      function enableArrowGroups(root = document) {
        root.querySelectorAll("[data-arrow-group]").forEach((group) => {
          group.addEventListener("keydown", (event) => {
            const keys = ["ArrowRight", "ArrowLeft", "ArrowDown", "ArrowUp"];
            if (!keys.includes(event.key)) return;
            const target = event.target;
            if (
              target.tagName === "INPUT" ||
              target.tagName === "TEXTAREA" ||
              target.tagName === "SELECT"
            )
              return;
            const items = Array.from(
              group.querySelectorAll(
                'a,button,summary,[role="radio"],[tabindex="0"]',
              ),
            ).filter(
              (el) =>
                !el.hasAttribute("disabled") &&
                el.getAttribute("tabindex") !== "-1",
            );
            const index = items.indexOf(target);
            if (index < 0) return;
            let nextIndex = index;
            if (event.key === "ArrowRight" || event.key === "ArrowDown")
              nextIndex = index + 1;
            if (event.key === "ArrowLeft" || event.key === "ArrowUp")
              nextIndex = index - 1;
            if (nextIndex !== index && items[nextIndex]) {
              event.preventDefault();
              items[nextIndex].focus();
            }
          });
        });
      }

      enableArrowGroups();

      window.onload = () => {
        showModal(
          "COGNIPLAY",
          "¬°Encuentra todas las palabras escondidas!",
          "¬°EMPEZAR!",
          () => {
            gameStarted = true;
            if (!isMusicPlaying) musicBtn.click();
            initGame();
          },
          true,
        );
      };
    </script>
  </body>
</html>
