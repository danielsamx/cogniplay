<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Mente de rayo - CogniPlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        background: radial-gradient(
          circle at center,
          #ffffff,
          #e2d1f9,
          #d0e8ff
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }
      .perspective-1000 {
        perspective: 1000px;
      }
      .card-inner {
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-style: preserve-3d;
        position: relative;
        width: 100%;
        height: 100%;
      }
      .card.flipped .card-inner {
        transform: rotateY(180deg);
      }
      .backface-hidden {
        backface-visibility: hidden;
      }

      /* Accesibilidad: Foco visible */
      :focus-visible {
        outline: 3px solid #9333ea;
        outline-offset: 4px;
      }

      /* --- ESTILO DE TOOLTIPS PERSONALIZADOS --- */
      [data-tooltip] {
        position: relative;
      }
      [data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: bold;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 100;
        pointer-events: none;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      }
      [data-tooltip]:hover::after,
      [data-tooltip]:focus-visible::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.2s ease;
      }
      .btn-active {
        background: #9333ea !important;
        color: white !important;
        transform: scale(1.05);
      }
      .modal-animate {
        animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .paused-cards .card-inner {
        filter: blur(10px) grayscale(1);
        pointer-events: none;
      }
    </style>
  </head>
  <body class="p-2 sm:p-4 font-sans text-slate-800">
    <nav
      class="sticky top-0 z-40 w-full py-2 mb-4 sm:mb-8 px-2"
      role="navigation"
    >
      <div class="max-w-5xl mx-auto flex items-center justify-between gap-2">
        <div class="flex items-center gap-2 sm:gap-4">
          <div class="flex items-center gap-2 group cursor-default">
            <img
              src="../assets/logo.png"
              alt="Logo de CogniPlay"
              class="w-6 h-6 md:w-12 md:h-12"
            />
            <span
              class="text-lg sm:text-xl font-black tracking-tight hidden xs:block"
              aria-hidden="true"
              >Cogni<span class="text-purple-600">Play</span></span
            >
          </div>
          <div class="h-6 sm:h-8 w-[1px] bg-slate-200 mx-1"></div>
          <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
            <a
              href="explorar.html"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              data-tooltip="Ir a juegos"
              aria-label="Volver a explorar"
              >üéÆ</a
            >
            <button
              onclick="togglePause()"
              class="p-1.5 sm:p-2 hover:bg-white rounded-lg transition-all"
              data-tooltip="Pausar juego"
              aria-label="Pausar cron√≥metro"
            >
              ‚è∏Ô∏è
            </button>
          </div>
        </div>

        <div
          class="flex flex-col items-center flex-grow sm:flex-none"
          role="timer"
          aria-live="polite"
        >
          <div
            class="flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-1 bg-white rounded-full shadow-sm border border-slate-100"
          >
            <span class="animate-pulse text-sm sm:text-base" aria-hidden="true"
              >‚è±Ô∏è</span
            >
            <span
              id="timer-text"
              class="font-mono font-bold text-sm sm:text-lg text-slate-700"
              >00:00</span
            >
          </div>
        </div>

        <div class="flex gap-1 sm:gap-2">
          <div
            class="flex bg-slate-100 p-1 rounded-xl sm:rounded-2xl shadow-inner"
            role="group"
            aria-label="Marcador"
          >
            <div
              class="px-2 sm:px-4 py-1 rounded-lg sm:rounded-xl bg-white shadow-sm flex flex-col items-center min-w-[50px]"
            >
              <span
                class="text-[7px] sm:text-[9px] uppercase font-black text-purple-500"
                >Nivel</span
              >
              <span
                id="level-display"
                class="text-sm sm:text-lg font-black leading-none"
                >1</span
              >
            </div>
            <div
              class="px-2 sm:px-4 py-1 rounded-lg sm:rounded-xl flex flex-col items-center min-w-[50px]"
            >
              <span
                class="text-[7px] sm:text-[9px] uppercase font-black text-yellow-500"
                >Puntos</span
              >
              <span
                id="score-display"
                class="text-sm sm:text-lg font-black leading-none text-slate-700"
                >0</span
              >
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="w-full flex-grow flex flex-col items-center px-1 sm:px-4">
      <div class="w-full max-w-md mb-4 sm:mb-6">
        <div
          class="w-full bg-slate-200 h-2 sm:h-3 rounded-full overflow-hidden shadow-inner"
          role="progressbar"
          aria-label="Progreso del tiempo"
        >
          <div
            id="timer-progress"
            class="h-full bg-gradient-to-r from-blue-400 to-purple-500 w-full transition-all duration-1000"
          ></div>
        </div>
      </div>
      <div
        id="game-grid"
        class="grid gap-2 sm:gap-3 perspective-1000 w-full justify-items-center mb-10"
        role="main"
        aria-label="Tablero de cartas"
      ></div>
    </main>

    <div
      id="modal-overlay"
      class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4"
      role="dialog"
      aria-modal="true"
    >
      <div
        id="modal-content"
        class="glass p-6 sm:p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center modal-animate border-4 border-white"
      >
        <h2
          id="modal-title"
          class="text-2xl sm:text-3xl font-black mb-2 text-slate-800"
        ></h2>
        <div
          id="modal-body"
          class="text-slate-600 font-medium mb-6 text-sm sm:text-base"
        ></div>
        <div class="flex flex-col gap-3">
          <button
            id="modal-btn-primary"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-3 rounded-2xl shadow-lg transition-transform active:scale-95 text-lg"
            data-tooltip="Haz clic para continuar"
          ></button>
          <a
            href="explorar.html"
            id="modal-btn-secondary"
            class="w-full bg-white/50 hover:bg-white text-slate-600 font-bold py-2 rounded-2xl transition-colors hidden text-base text-center"
            data-tooltip="Volver al men√∫"
            >Salir</a
          >
        </div>
      </div>
    </div>

    <button
      id="music-toggle"
      class="fixed bottom-4 right-4 w-12 h-12 glass rounded-full shadow-2xl flex items-center justify-center text-xl z-40"
      data-tooltip="Sonido ON/OFF"
      aria-label="Alternar m√∫sica de fondo"
    >
      üîá
    </button>

    <audio id="bg-music" loop src="../music/memory-bg.mp3"></audio>
    <audio
      id="snd-flip"
      src="https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.mp3"
    ></audio>
    <audio id="snd-match" src="../music/match.mp3"></audio>
    <audio id="snd-wrong" src="../music/wrong.mp3"></audio>
    <audio id="snd-win" src="../music/game-win.mp3"></audio>
    <audio id="snd-gameover" src="../music/game-over.mp3"></audio>
    <audio id="snd-alert" loop src="../music/fast-ticking.mp3"></audio>

    <script>
      let difficulty = "medio";
      let category = "animales";
      let level = 1;
      let score = 0;
      let timeLeft, timerInterval;
      let flippedCards = [],
        matchedPairs = 0;
      let canFlip = false,
        isPaused = false,
        isMusicPlaying = false,
        isAlertActive = false;

      const grid = document.getElementById("game-grid");
      const levelDisplay = document.getElementById("level-display");
      const scoreDisplay = document.getElementById("score-display");
      const timerProgress = document.getElementById("timer-progress");
      const musicBtn = document.getElementById("music-toggle");
      const bgMusic = document.getElementById("bg-music");
      const sndAlert = document.getElementById("snd-alert");
      const modal = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const btnPrimary = document.getElementById("modal-btn-primary");
      const btnSecondary = document.getElementById("modal-btn-secondary");

      const transportes = [
        "avion",
        "barco",
        "bicicleta",
        "bus",
        "carro",
        "cohete",
        "dron",
        "ferry",
        "globo",
        "helicoptero",
        "motocicleta",
        "patineta",
        "submarino",
        "taxi",
        "tractor",
        "tranvia",
        "tren",
        "velero",
      ];
      const animales = [
        "ballena",
        "burro",
        "caballo",
        "caballito de mar",
        "cabra",
        "caracol",
        "cebra",
        "cerdo",
        "conejo",
        "delfin",
        "elefante",
        "estrella de mar",
        "flamenco",
        "gallina",
        "gato",
        "hasmter",
        "hipopotamo",
        "hormiga",
        "jirafa",
        "leon",
        "loro",
        "medusa",
        "mono",
        "oso",
        "oveja",
        "pajaro",
        "panda",
        "pato",
        "perro",
        "pez",
        "pinguino",
        "pollo",
        "pulpo",
        "rinoceronte",
        "tiburon",
        "tigre",
        "tortuga",
        "vaca",
      ];

      function setDifficulty(val, el) {
        difficulty = val;
        document
          .querySelectorAll(".btn-difficulty")
          .forEach((b) => b.classList.remove("btn-active"));
        el.classList.add("btn-active");
      }

      function setCategory(val, el) {
        category = val;
        document
          .querySelectorAll(".btn-category")
          .forEach((b) => b.classList.remove("btn-active"));
        el.classList.add("btn-active");
      }

      musicBtn.onclick = () => {
        isMusicPlaying ? bgMusic.pause() : bgMusic.play();
        musicBtn.innerText = isMusicPlaying ? "üîá" : "üéµ";
        isMusicPlaying = !isMusicPlaying;
      };

      function playSnd(id) {
        const snd = document.getElementById(id);
        snd.currentTime = 0;
        snd.play().catch(() => {});
      }

      function stopAlert() {
        sndAlert.pause();
        sndAlert.currentTime = 0;
        bgMusic.volume = 1.0;
        isAlertActive = false;
        document
          .getElementById("timer-text")
          .classList.remove("text-red-500", "animate-bounce");
        timerProgress.classList.remove("bg-red-500");
      }

      function showModal(
        title,
        bodyHTML,
        primaryText,
        primaryAction,
        showExit = false,
      ) {
        modalTitle.innerText = title;
        modalBody.innerHTML = bodyHTML;
        btnPrimary.innerText = primaryText;
        btnPrimary.onclick = () => {
          modal.classList.add("hidden");
          primaryAction();
        };
        btnSecondary.classList.toggle("hidden", !showExit);
        modal.classList.remove("hidden");
        setTimeout(() => btnPrimary.focus(), 100);
      }

      function initGame() {
        grid.innerHTML = "";
        grid.classList.remove("paused-cards");
        flippedCards = [];
        matchedPairs = 0;
        canFlip = false;
        stopAlert();
        if (isMusicPlaying) bgMusic.play();

        let basePairs =
          difficulty === "facil" ? 2 : difficulty === "medio" ? 3 : 4;
        let numPairs = Math.min(basePairs + Math.floor(level * 0.7), 15);
        let sourcePool =
          category === "animales"
            ? animales
            : category === "transportes"
              ? transportes
              : [...animales, ...transportes];
        const selected = [...sourcePool]
          .sort(() => 0.5 - Math.random())
          .slice(0, numPairs);
        const cardValues = [...selected, ...selected].sort(
          () => Math.random() - 0.5,
        );

        let cols =
          numPairs <= 4
            ? "grid-cols-2 sm:grid-cols-4"
            : "grid-cols-4 sm:grid-cols-6";
        grid.className = `grid gap-2 sm:gap-3 justify-items-center ${cols}`;

        cardValues.forEach((val, index) => {
          const card = document.createElement("button");
          const sizeClass =
            numPairs > 8
              ? "w-16 h-24 sm:w-24 sm:h-32"
              : "w-20 h-28 sm:w-28 sm:h-36";
          card.className = `card ${sizeClass} cursor-pointer perspective-1000`;
          card.setAttribute("aria-label", `Carta ${index + 1}`);
          card.setAttribute("data-tooltip", "Revelar");

          const folder = transportes.includes(val) ? "transportes" : "animales";
          card.innerHTML = `
            <div class="card-inner shadow-lg rounded-xl sm:rounded-2xl">
              <div class="backface-hidden absolute inset-0 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl sm:rounded-2xl flex items-center justify-center text-2xl sm:text-4xl border-2 sm:border-4 border-white shadow-inner text-white font-black">?</div>
              <div class="backface-hidden absolute inset-0 bg-white rounded-xl sm:rounded-2xl flex items-center justify-center [transform:rotateY(180deg)] border-2 border-purple-400 overflow-hidden">
                <img src="../images/${folder}/${val}.png" alt="${val}" class="w-full h-full object-cover">
              </div>
            </div>`;
          card.dataset.value = val;
          card.onclick = () => flipCard(card);
          grid.appendChild(card);
        });

        setTimeout(() => {
          document
            .querySelectorAll(".card")
            .forEach((c) => c.classList.add("flipped"));
          setTimeout(
            () => {
              document
                .querySelectorAll(".card")
                .forEach((c) => c.classList.remove("flipped"));
              canFlip = true;
              startTimer();
            },
            Math.max(1200, 2200 - level * 100),
          );
        }, 300);
      }

      function startTimer(resume = false) {
        clearInterval(timerInterval);
        const timerText = document.getElementById("timer-text");
        let totalTime = Math.min(10 + (level - 1) * 2.5, 35);
        if (!resume) timeLeft = totalTime;

        timerInterval = setInterval(() => {
          if (!isPaused) {
            timeLeft--;
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            timerText.innerText = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
            timerProgress.style.width = (timeLeft / totalTime) * 100 + "%";

            if (timeLeft <= 5 && timeLeft > 0) {
              timerProgress.classList.add("bg-red-500");
              timerText.classList.add("text-red-500", "animate-bounce");
              if (!isAlertActive && isMusicPlaying) {
                sndAlert.play();
                bgMusic.volume = 0.4;
                isAlertActive = true;
              }
            }
            if (timeLeft <= 0) {
              stopAlert();
              gameOver();
            }
          }
        }, 1000);
      }

      function flipCard(card) {
        if (
          !canFlip ||
          isPaused ||
          card.classList.contains("flipped") ||
          flippedCards.includes(card)
        )
          return;
        playSnd("snd-flip");
        card.classList.add("flipped");
        card.removeAttribute("data-tooltip");
        flippedCards.push(card);
        if (flippedCards.length === 2) {
          canFlip = false;
          checkMatch();
        }
      }

      function checkMatch() {
        const [c1, c2] = flippedCards;
        if (c1.dataset.value === c2.dataset.value) {
          playSnd("snd-match");
          matchedPairs++;
          score += level * 100;
          updateUI();
          flippedCards = [];
          canFlip = true;
          if (matchedPairs === document.querySelectorAll(".card").length / 2)
            handleWin();
        } else {
          setTimeout(() => {
            playSnd("snd-wrong");
            c1.classList.remove("flipped");
            c2.classList.remove("flipped");
            c1.setAttribute("data-tooltip", "Revelar");
            c2.setAttribute("data-tooltip", "Revelar");
            flippedCards = [];
            canFlip = true;
          }, 800);
        }
      }

      function handleWin() {
        clearInterval(timerInterval);
        stopAlert();
        playSnd("snd-win");
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        showModal(
          level === 10 ? "üèÜ ¬°VICTORIA!" : `¬°NIVEL ${level} LISTO!`,
          level === 10 ? `Puntos totales: ${score}` : "¬°Sigue as√≠!",
          level === 10 ? "REINICIAR" : "SIGUIENTE",
          () => {
            if (level < 10) {
              level++;
              updateUI();
              initGame();
            } else resetGame();
          },
          true,
        );
      }

      function gameOver() {
        clearInterval(timerInterval);
        stopAlert();
        bgMusic.pause();
        playSnd("snd-gameover");
        showModal(
          "TIEMPO FUERA",
          `Nivel alcanzado: ${level}`,
          "REINTENTAR",
          resetGame,
          true,
        );
      }

      function resetGame() {
        level = 1;
        score = 0;
        updateUI();
        initGame();
      }
      function updateUI() {
        levelDisplay.innerText = level;
        scoreDisplay.innerText = score;
      }

      function togglePause() {
        if (!canFlip && !isPaused) return;
        isPaused = !isPaused;
        if (isPaused) {
          clearInterval(timerInterval);
          bgMusic.pause();
          sndAlert.pause();
          grid.classList.add("paused-cards");
          showModal(
            "PAUSA",
            "¬øQuieres continuar?",
            "REANUDAR",
            togglePause,
            true,
          );
        } else {
          grid.classList.remove("paused-cards");
          if (isMusicPlaying) bgMusic.play();
          if (isAlertActive) sndAlert.play();
          startTimer(true);
        }
      }

      window.onload = () => {
        showModal(
          "COGNIPLAY",
          `<div class="text-left space-y-4">
            <div>
              <p class="font-black text-[10px] mb-2 text-purple-500 uppercase">Dificultad</p>
              <div class="flex gap-2" role="radiogroup">
                <button onclick="setDifficulty('facil', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold text-sm" data-tooltip="Modo Relax">F√°cil</button>
                <button onclick="setDifficulty('medio', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold btn-active text-sm" data-tooltip="Modo Est√°ndar">Medio</button>
                <button onclick="setDifficulty('dificil', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold text-sm" data-tooltip="Modo Experto">Dif√≠cil</button>
              </div>
            </div>
            <div>
              <p class="font-black text-[10px] mb-2 text-purple-500 uppercase">Tem√°tica</p>
              <div class="flex gap-2" role="radiogroup">
                <button onclick="setCategory('animales', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold btn-active text-sm" data-tooltip="Naturaleza">Animales</button>
                <button onclick="setCategory('transportes', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold text-sm" data-tooltip="Aventuras">Viajes</button>
                <button onclick="setCategory('mixto', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold text-sm" data-tooltip="Todo junto">Mixto</button>
              </div>
            </div>
          </div>`,
          "¬°EMPEZAR!",
          () => {
            if (!isMusicPlaying) musicBtn.click();
            initGame();
          },
          true,
        );
      };
    </script>
  </body>
</html>
