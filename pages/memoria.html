<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reto de Memoria | CogniPlay</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        background: radial-gradient(
          circle at center,
          #ffffff,
          #e2d1f9,
          #d0e8ff
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .perspective-1000 {
        perspective: 1000px;
      }
      .card-inner {
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-style: preserve-3d;
        position: relative;
        width: 100%;
        height: 100%;
      }
      .card.flipped .card-inner {
        transform: rotateY(180deg);
      }
      .backface-hidden {
        backface-visibility: hidden;
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.2s ease;
      }

      .btn-active {
        background: #9333ea !important;
        color: white !important;
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .modal-animate {
        animation: zoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .paused-cards .card-inner {
        filter: blur(10px) grayscale(1);
        pointer-events: none;
      }

      /* Tooltip animado */
      [data-tooltip] {
        position: relative;
        cursor: pointer;
      }
      [data-tooltip]:before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%) scale(0);
        background: #1e293b;
        color: white;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        transition: all 0.2s ease;
        opacity: 0;
        z-index: 100;
      }
      [data-tooltip]:hover:before {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }

      /* Efecto de cristal para el Navbar */
      .nav-glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(15px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body class="p-4 font-sans text-slate-800">
    <nav class="sticky top-0 z-40 w-full py-3 mb-8 px-4">
      <div class="max-w-5xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 group cursor-default">
            <div
              class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg transform group-hover:rotate-12 transition-transform"
            >
              <span class="text-white font-black text-xl">C</span>
            </div>
            <span class="text-xl font-black tracking-tight hidden sm:block">
              Cogni<span class="text-purple-600">Play</span>
            </span>
          </div>

          <div class="h-8 w-[1px] bg-slate-200 mx-2"></div>

          <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
            <a
              href="explorar.html"
              data-tooltip="Ir al Men√∫"
              class="p-2 hover:bg-white rounded-lg transition-all"
              >üè†</a
            >
            <button
              onclick="togglePause()"
              data-tooltip="Pausar Juego"
              class="p-2 hover:bg-white rounded-lg transition-all"
            >
              ‚è∏Ô∏è
            </button>
          </div>
        </div>

        <div
          class="absolute left-1/2 -translate-x-1/2 flex flex-col items-center"
        >
          <div
            class="flex items-center gap-2 px-4 py-1 bg-white rounded-full shadow-sm border border-slate-100"
          >
            <span class="animate-pulse">‚è±Ô∏è</span>
            <span
              id="timer-text"
              class="font-mono font-bold text-lg text-slate-700"
              >00:00</span
            >
          </div>
        </div>

        <div class="flex gap-2">
          <div class="flex bg-slate-100 p-1 rounded-2xl shadow-inner">
            <div
              class="px-4 py-1 rounded-xl bg-white shadow-sm flex flex-col items-center min-w-[70px]"
            >
              <span class="text-[9px] uppercase font-black text-purple-500"
                >Nivel</span
              >
              <span id="level-display" class="text-lg font-black leading-none"
                >1</span
              >
            </div>
            <div
              class="px-4 py-1 rounded-xl flex flex-col items-center min-w-[70px]"
            >
              <span class="text-[9px] uppercase font-black text-yellow-500"
                >Puntos</span
              >
              <span
                id="score-display"
                class="text-lg font-black leading-none text-slate-700"
                >0</span
              >
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="max-w-4xl mx-auto w-full flex-grow flex flex-col items-center">
      <div class="w-full max-w-md mb-6">
        <div
          class="w-full bg-slate-200 h-3 rounded-full overflow-hidden shadow-inner"
        >
          <div
            id="timer-progress"
            class="h-full bg-gradient-to-r from-blue-400 to-purple-500 w-full transition-all duration-1000"
          ></div>
        </div>
      </div>
      <div
        id="game-grid"
        class="grid gap-3 perspective-1000 w-full justify-items-center mb-10"
      ></div>
    </main>

    <div
      id="modal-overlay"
      class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center hidden p-4"
    >
      <div
        id="modal-content"
        class="glass p-8 rounded-[3rem] shadow-2xl max-w-sm w-full text-center modal-animate border-4 border-white"
      >
        <h2
          id="modal-title"
          class="text-3xl font-black mb-2 text-slate-800"
        ></h2>
        <div id="modal-body" class="text-slate-600 font-medium mb-8"></div>
        <div class="flex flex-col gap-3">
          <button
            id="modal-btn-primary"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-4 rounded-2xl shadow-lg transition-transform active:scale-95 text-xl"
          ></button>
          <a
            href="explorar.html"
            id="modal-btn-secondary"
            class="w-full bg-white/50 hover:bg-white text-slate-600 font-bold py-3 rounded-2xl transition-colors hidden text-lg"
          >
            Salir al Men√∫
          </a>
        </div>
      </div>
    </div>

    <button
      id="music-toggle"
      class="fixed bottom-6 right-6 w-14 h-14 glass rounded-full shadow-2xl flex items-center justify-center text-2xl z-40"
    >
      üîá
    </button>

    <audio
      id="bg-music"
      loop
      src="https://assets.mixkit.co/music/preview/mixkit-pop-05-695.mp3"
    ></audio>
    <audio
      id="snd-flip"
      src="https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.mp3"
    ></audio>
    <audio
      id="snd-match"
      src="https://assets.mixkit.co/sfx/preview/mixkit-magic-notification-ring-2359.mp3"
    ></audio>
    <audio
      id="snd-wrong"
      src="https://assets.mixkit.co/sfx/preview/mixkit-short-low-sad-trumpet-2303.mp3"
    ></audio>
    <audio
      id="snd-win"
      src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"
    ></audio>
    <audio
      id="snd-gameover"
      src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3"
    ></audio>

    <script>
      let difficulty = "medio";
      let category = "animales";
      let level = 1;
      let score = 0;
      let timeLeft;
      let timerInterval;
      let flippedCards = [];
      let canFlip = false;
      let matchedPairs = 0;
      let isPaused = false;
      let isMusicPlaying = false;

      const grid = document.getElementById("game-grid");
      const levelDisplay = document.getElementById("level-display");
      const scoreDisplay = document.getElementById("score-display");
      const timerProgress = document.getElementById("timer-progress");
      const musicBtn = document.getElementById("music-toggle");
      const bgMusic = document.getElementById("bg-music");
      const modal = document.getElementById("modal-overlay");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      const btnPrimary = document.getElementById("modal-btn-primary");
      const btnSecondary = document.getElementById("modal-btn-secondary");

      const transportes = [
        "avion",
        "barco",
        "bicicleta",
        "bus",
        "carro",
        "cohete",
        "dron",
        "ferry",
        "globo",
        "helicoptero",
        "motocicleta",
        "patineta",
        "submarino",
        "taxi",
        "tractor",
        "tranvia",
        "tren",
        "velero",
      ];
      const animales = [
        "ballena",
        "burro",
        "caballo",
        "caballito de mar",
        "cabra",
        "caracol",
        "cebra",
        "cerdo",
        "conejo",
        "delfin",
        "elefante",
        "estrella de mar",
        "flamenco",
        "gallina",
        "gato",
        "hasmter",
        "hipopotamo",
        "hormiga",
        "jirafa",
        "leon",
        "loro",
        "medusa",
        "mono",
        "oso",
        "oveja",
        "pajaro",
        "panda",
        "pato",
        "perro",
        "pez",
        "pinguino",
        "pollo",
        "pulpo",
        "rinoceronte",
        "tiburon",
        "tigre",
        "tortuga",
        "vaca",
      ];

      function setDifficulty(val, el) {
        difficulty = val;
        document
          .querySelectorAll(".btn-difficulty")
          .forEach((b) => b.classList.remove("btn-active"));
        el.classList.add("btn-active");
      }

      function setCategory(val, el) {
        category = val;
        document
          .querySelectorAll(".btn-category")
          .forEach((b) => b.classList.remove("btn-active"));
        el.classList.add("btn-active");
      }

      musicBtn.onclick = () => {
        isMusicPlaying ? bgMusic.pause() : bgMusic.play();
        musicBtn.innerText = isMusicPlaying ? "üîá" : "üéµ";
        isMusicPlaying = !isMusicPlaying;
      };

      function playSnd(id) {
        const snd = document.getElementById(id);
        snd.currentTime = 0;
        snd.play().catch(() => {});
      }

      function showModal(
        title,
        bodyHTML,
        primaryText,
        primaryAction,
        showExit = false,
      ) {
        modalTitle.innerText = title;
        modalBody.innerHTML = bodyHTML;
        btnPrimary.innerText = primaryText;
        btnPrimary.onclick = () => {
          modal.classList.add("hidden");
          primaryAction();
        };
        btnSecondary.classList.toggle("hidden", !showExit);
        modal.classList.remove("hidden");
      }

      function initGame() {
        grid.innerHTML = "";
        grid.classList.remove("paused-cards");
        flippedCards = [];
        matchedPairs = 0;
        canFlip = false;

        // AUMENTO PROGRESIVO DE CARTAS
        let basePairs =
          difficulty === "facil" ? 2 : difficulty === "medio" ? 3 : 4;
        let numPairs = basePairs + Math.floor(level * 0.7);
        numPairs = Math.min(numPairs, 15); // M√°ximo 30 cartas para jugabilidad

        let sourcePool =
          category === "animales"
            ? animales
            : category === "transportes"
              ? transportes
              : [...animales, ...transportes];
        const selected = [...sourcePool]
          .sort(() => 0.5 - Math.random())
          .slice(0, numPairs);
        const cardValues = [...selected, ...selected].sort(
          () => Math.random() - 0.5,
        );

        // Grid adaptativo
        let cols =
          numPairs <= 4
            ? "grid-cols-2 md:grid-cols-4"
            : numPairs <= 9
              ? "grid-cols-3 md:grid-cols-6"
              : "grid-cols-4 md:grid-cols-6";
        grid.className = `grid gap-3 justify-items-center ${cols}`;

        cardValues.forEach((val) => {
          const card = document.createElement("div");
          const sizeClass =
            numPairs > 8
              ? "w-20 h-28 md:w-24 md:h-32"
              : "w-24 h-32 md:w-28 md:h-36";
          card.className = `card ${sizeClass} cursor-pointer perspective-1000`;
          const folder = transportes.includes(val) ? "transportes" : "animales";

          card.innerHTML = `
            <div class="card-inner shadow-lg rounded-2xl">
              <div class="backface-hidden absolute inset-0 bg-gradient-to-br from-purple-500 to-blue-500 rounded-2xl flex items-center justify-center text-4xl border-4 border-white shadow-inner text-white">?</div>
              <div class="backface-hidden absolute inset-0 bg-white rounded-2xl flex items-center justify-center [transform:rotateY(180deg)] border-2 border-purple-400 overflow-hidden">
                <img src="../images/${folder}/${val}.png" alt="${val}" class="w-full h-full object-cover">
              </div>
            </div>`;

          card.dataset.value = val;
          card.onclick = () => flipCard(card);
          grid.appendChild(card);
        });

        // Vistazo inicial se reduce ligeramente con el nivel
        let peekTime = Math.max(1000, 2000 - level * 100);
        setTimeout(() => {
          document
            .querySelectorAll(".card")
            .forEach((c) => c.classList.add("flipped"));
          setTimeout(() => {
            document
              .querySelectorAll(".card")
              .forEach((c) => c.classList.remove("flipped"));
            canFlip = true;
            startTimer();
          }, peekTime);
        }, 500);
      }

      function startTimer(resume = false) {
        clearInterval(timerInterval);

        // TIEMPO INVERSO: Nivel 1 = 10s, sube 2.5s por nivel, M√°ximo 35s
        let calculatedTime = 10 + (level - 1) * 2.5;
        let totalTime = Math.min(calculatedTime, 35);

        if (!resume) timeLeft = totalTime;

        timerInterval = setInterval(() => {
          if (!isPaused) {
            timeLeft--;
            const percentage = (timeLeft / totalTime) * 100;
            timerProgress.style.width = percentage + "%";

            // Alerta visual de tiempo bajo (3 segundos o menos)
            if (timeLeft <= 3) {
              timerProgress.classList.add("bg-red-500");
              timerProgress.classList.remove(
                "bg-gradient-to-r",
                "from-blue-400",
                "to-purple-500",
              );
            } else {
              timerProgress.classList.remove("bg-red-500");
              timerProgress.classList.add(
                "bg-gradient-to-r",
                "from-blue-400",
                "to-purple-500",
              );
            }

            if (timeLeft <= 0) gameOver();
          }
        }, 1000);
      }

      function startTimer(resume = false) {
        clearInterval(timerInterval);
        const timerText = document.getElementById("timer-text"); // Referencia al nuevo texto

        let calculatedTime = 10 + (level - 1) * 2.5;
        let totalTime = Math.min(calculatedTime, 35);

        if (!resume) timeLeft = totalTime;

        timerInterval = setInterval(() => {
          if (!isPaused) {
            timeLeft--;

            // Actualizar Texto del Cron√≥metro
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerText.innerText = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            const percentage = (timeLeft / totalTime) * 100;
            timerProgress.style.width = percentage + "%";

            // Alerta visual
            if (timeLeft <= 3) {
              timerProgress.classList.add("bg-red-500");
              timerText.classList.add("text-red-500", "animate-bounce");
            } else {
              timerProgress.classList.remove("bg-red-500");
              timerText.classList.remove("text-red-500", "animate-bounce");
            }

            if (timeLeft <= 0) gameOver();
          }
        }, 1000);
      }

      function flipCard(card) {
        if (
          !canFlip ||
          isPaused ||
          card.classList.contains("flipped") ||
          flippedCards.includes(card)
        )
          return;
        playSnd("snd-flip");
        card.classList.add("flipped");
        flippedCards.push(card);
        if (flippedCards.length === 2) {
          canFlip = false;
          checkMatch();
        }
      }

      function checkMatch() {
        const [c1, c2] = flippedCards;
        if (c1.dataset.value === c2.dataset.value) {
          playSnd("snd-match");
          matchedPairs++;
          score += level * 100;
          updateUI();
          flippedCards = [];
          canFlip = true;
          if (matchedPairs === document.querySelectorAll(".card").length / 2)
            handleWin();
        } else {
          setTimeout(() => {
            playSnd("snd-wrong");
            c1.classList.remove("flipped");
            c2.classList.remove("flipped");
            flippedCards = [];
            canFlip = true;
          }, 800);
        }
      }

      function lanzarConfeti() {
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = {
          startVelocity: 30,
          spread: 360,
          ticks: 60,
          zIndex: 0,
        };

        const randomInRange = (min, max) => Math.random() * (max - min) + min;

        const interval = setInterval(function () {
          const timeLeft = animationEnd - Date.now();

          if (timeLeft <= 0) {
            return clearInterval(interval);
          }

          const particleCount = 50 * (timeLeft / duration);

          // Lanzar confeti desde dos puntos (izquierda y derecha)
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
          });
          confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
          });
        }, 250);
      }

      function handleWin() {
        clearInterval(timerInterval);
        playSnd("snd-win");
        lanzarConfeti();
        if (level === 10) {
          showModal(
            "üèÜ ¬°VICTORIA!",
            `¬°Completaste el reto! Puntos: ${score}`,
            "REPETIR",
            resetGame,
            true,
          );
        } else {
          showModal(
            `¬°NIVEL ${level} LISTO!`,
            "Tu memoria es excelente.",
            "SIGUIENTE",
            () => {
              level++;
              updateUI();
              initGame();
            },
            true,
          );
        }
      }

      function gameOver() {
        clearInterval(timerInterval);
        playSnd("snd-gameover");
        showModal(
          "TIEMPO FUERA",
          `Llegaste al nivel ${level}.`,
          "REINTENTAR",
          resetGame,
          true,
        );
      }

      function resetGame() {
        level = 1;
        score = 0;
        updateUI();
        initGame();
      }

      function updateUI() {
        levelDisplay.innerText = level;
        scoreDisplay.innerText = score;
      }

      function togglePause() {
        if (!canFlip && !isPaused) return;
        isPaused = !isPaused;
        if (isPaused) {
          clearInterval(timerInterval);
          grid.classList.add("paused-cards");
          showModal(
            "PAUSA",
            "¬øQuieres continuar?",
            "REANUDAR",
            togglePause,
            true,
          );
        } else {
          grid.classList.remove("paused-cards");
          startTimer(true);
        }
      }

      window.onload = () => {
        showModal(
          "COGNIPLAY",
          `<div class="text-left space-y-4">
            <div>
              <p class="font-black text-sm mb-2 text-purple-500">DIFICULTAD</p>
              <div class="flex gap-2">
                <button onclick="setDifficulty('facil', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold">F√°cil</button>
                <button onclick="setDifficulty('medio', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold btn-active">Medio</button>
                <button onclick="setDifficulty('dificil', this)" class="btn-difficulty glass flex-1 py-2 rounded-xl font-bold">Dif√≠cil</button>
              </div>
            </div>
            <div>
              <p class="font-black text-sm mb-2 text-purple-500">TEM√ÅTICA</p>
              <div class="flex gap-2">
                <button onclick="setCategory('animales', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold btn-active">Animales</button>
                <button onclick="setCategory('transportes', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold">Viajes</button>
                <button onclick="setCategory('mixto', this)" class="btn-category glass flex-1 py-2 rounded-xl font-bold">Mixto</button>
              </div>
            </div>
          </div>`,
          "¬°EMPEZAR!",
          () => {
            if (!isMusicPlaying) musicBtn.click();
            initGame();
          },
          true,
        );
      };
    </script>
  </body>
</html>
